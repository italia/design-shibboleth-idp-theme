##
## Velocity Template for DisplayAttributeReleasePage view-state
##
## Velocity context will contain the following properties :
##
## attributeReleaseContext - context holding consentable attributes
## attributeReleaseFlowDescriptor - attribute consent flow descriptor
## attributeDisplayNameFunction - function to display attribute name
## attributeDisplayDescriptionFunction - function to display attribute description
## consentContext - context representing the state of a consent flow
## encoder - HTMLEncoder class
## flowExecutionKey - SWF execution key (this is built into the flowExecutionUrl)
## flowExecutionUrl - form action location
## flowRequestContext - Spring Web Flow RequestContext
## profileRequestContext - OpenSAML profile request context
## request - HttpServletRequest
## response - HttpServletResponse
## rpUIContext - context with SP UI information from the metadata
## environment - Spring Environment object for property resolution
#set ($serviceName = $rpUIContext.serviceName)
#set ($serviceDescription = $rpUIContext.serviceDescription)
#set ($informationURL = $rpUIContext.informationURL)
#set ($privacyStatementURL = $rpUIContext.privacyStatementURL)
#set ($rpOrganizationLogo = $rpUIContext.getLogo())
#set ($rpOrganizationName = $rpUIContext.organizationName)
#set ($replaceDollarWithNewline = true)
##
<!DOCTYPE html>
<html>
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <!-- Page details -->
        <title>#springMessageText("idp.attribute-release.title", "Information Release")</title>
        <!-- CSS -->
        <link rel="stylesheet" href="$request.getContextPath()/bootstrap-italia/css/bootstrap-italia.min.css">
        <link rel="stylesheet" href="$request.getContextPath()/bootstrap-italia/css/custom.css">
        <!-- Extra CSS/Javascript -->
    </head>

    <body>
        <!-- Bootstrap Italia header wrapper -->
        #parse("bi_header_wrapper.vm")

        <div class="main-body">
            <div class="container">
                <h2 class="my-5 px-4 px-md-0">
                    #springMessageText("idp.attribute-release.title",
                                       "Information Release")
                </h2>

                <form action="$flowExecutionUrl" method="post">
                    <div class="box">
                        #if ($serviceName)
                            <p>
                                #springMessageText("idp.attribute-release.serviceNameLabel",
                                                   "You are about to access the service:")
                                <br>
                                <span class="service_name">$serviceName</span>
                                #if ($rpOrganizationName)
                                    #springMessageText("idp.attribute-release.of", "of")
                                    <span class="organization_name">
                                        $encoder.encodeForHTML($rpOrganizationName)
                                    </span>
                                #end
                            </p>
                        #end
                        #if ($serviceDescription)
                            <p>
                                #springMessageText("idp.attribute-release.serviceDescriptionLabel",
                                                   "Description as provided by this service:")<br>
                                <span class="service_description">
                                    $encoder.encodeForHTML($serviceDescription)
                                </span>
                                <br>
                            </p>
                        #end
                        #if ($informationURL)
                            <p>
                                <a href="$informationURL">
                                    #springMessageText("idp.attribute-release.informationURLLabel",
                                                       "Additional information about the service")
                                </a>
                            </p>
                        #end
                        <div id="attributeRelease">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th colspan="3" class="px-0">
                                            #springMessageText("idp.attribute-release.attributesHeader",
                                                               "Information to be Provided to Service")
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    #foreach ($attribute in $attributeReleaseContext.getConsentableAttributes().values())
                                        <tr>
                                            <td>$encoder.encodeForHTML($attributeDisplayNameFunction.apply($attribute))</td>
                                            <td>
                                                #foreach ($value in $attribute.values)
                                                    #if ($replaceDollarWithNewline)
                                                        #set ($encodedValue = $encoder.encodeForHTML($value.getDisplayValue()).replaceAll($encoder.encodeForHTML("$"),"<br>"))
                                                    #else
                                                        #set ($encodedValue = $encoder.encodeForHTML($value.getDisplayValue()))
                                                    #end
                                                    #if ($attributeReleaseFlowDescriptor.perAttributeConsentEnabled)
                                                        <label for="$attribute.id"><strong>$encodedValue</strong></label>
                                                    #else
                                                        <strong>$encodedValue</strong>
                                                    #end
                                                #end
                                            </td>
                                            <td style="vertical-align: top">
                                                #if ($attributeReleaseFlowDescriptor.perAttributeConsentEnabled)
                                                    #set ($inputType = "checkbox")
                                                #else
                                                    #set ($inputType = "hidden")
                                                #end
                                                <input id="$attribute.id"
                                                       type="$inputType"
                                                       name="_shib_idp_consentIds"
                                                       value="$encoder.encodeForHTML($attribute.id)"
                                                       checked>
                                            </td>
                                        </tr>
                                    #end
                                </tbody>
                            </table>
                        </div>
                        #if ($privacyStatementURL)
                            <p style="margin-top: 10px;">
                                <a href="$privacyStatementURL">#springMessageText("idp.attribute-release.privacyStatementURLLabel",
                                                                                  "Data privacy information of the service")</a>
                            </p>
                        #end

                        <div class="card-wrapper card-space my-5">
                            <div class="card card-bg no-after">
                                <div class="card-body">
                                    <div class="card-text">
                                        <p>
                                            #springMessageText("idp.attribute-release.confirmationQuestion",
                                                               "The information above would be shared with the service if you proceed.
                                                                Do you agree to release this information to the service every time you access it?")
                                        </p>
                                        #if ($attributeReleaseFlowDescriptor.doNotRememberConsentAllowed || $attributeReleaseFlowDescriptor.globalConsentAllowed)
                                            <div id="generalConsentDiv">
                                                <div class="py-3">
                                                    <strong>
                                                        #springMessageText("idp.attribute-release.consentMethod",
                                                                           "Select an information release consent duration:")
                                                    </strong>
                                                </div>
                                        #end

                                        #if ($attributeReleaseFlowDescriptor.doNotRememberConsentAllowed)
                                            <div class="form-check form-check-group">
                                                <input id="_shib_idp_doNotRememberConsent"
                                                       type="radio"
                                                       name="_shib_idp_consentOptions"
                                                       value="_shib_idp_doNotRememberConsent">
                                                <label for="_shib_idp_doNotRememberConsent">
                                                    #springMessageText("idp.attribute-release.doNotRememberConsent",
                                                                       "Ask me again at next login")
                                                </label>
                                                <small id="_shib_idp_doNotRememberConsent-help" class="form-text">
                                                    #springMessageText("idp.attribute-release.doNotRememberConsentItem",
                                                                       "I agree to send my information this time.")
                                                </small>
                                            </div>
                                        #end

                                        #if ($attributeReleaseFlowDescriptor.doNotRememberConsentAllowed || $attributeReleaseFlowDescriptor.globalConsentAllowed)
                                            <div class="form-check form-check-group">
                                                <input id="_shib_idp_rememberConsent"
                                                       type="radio"
                                                       name="_shib_idp_consentOptions"
                                                       value="_shib_idp_rememberConsent" checked>
                                                <label for="_shib_idp_rememberConsent">
                                                    #springMessageText("idp.attribute-release.rememberConsent",
                                                                       "Ask me again if information changes")
                                                </label>
                                                <small id="_shib_idp_rememberConsent-help" class="form-text">
                                                    #springMessageText("idp.attribute-release.rememberConsentItem",
                                                                       "I agree that the same information will
                                                                       be sent automatically to this service
                                                                       in the future.")
                                                </small>
                                            </div>
                                        #end

                                        #if ($attributeReleaseFlowDescriptor.globalConsentAllowed)
                                            <div class="form-check form-check-group">
                                                <input id="_shib_idp_globalConsent"
                                                       type="radio"
                                                       name="_shib_idp_consentOptions"
                                                       value="_shib_idp_globalConsent">
                                                <label for="_shib_idp_globalConsent">
                                                    #springMessageText("idp.attribute-release.globalConsent",
                                                                       "Do not ask me again")
                                                </label>
                                                <small id="_shib_idp_globalConsent-help" class="form-text">
                                                    #springMessageText("idp.attribute-release.globalConsentItem",
                                                                       "I agree that <strong>all</strong> of my
                                                                       information will be released to
                                                                       <strong>any</strong> service.")
                                                </small>
                                            </div>
                                        #end
                                        #if ($attributeReleaseFlowDescriptor.doNotRememberConsentAllowed || $attributeReleaseFlowDescriptor.globalConsentAllowed)
                                                <div class="py-3">
                                                    <strong>
                                                        #springMessageText("idp.attribute-release.consentMethodRevoke",
                                                                           "This setting can be revoked at any time with
                                                                           the checkbox on the login page.")
                                                    </strong>
                                                </div>
                                            </div>
                                        #end
                                        <div class="mt-4">
                                            <input type="submit"
                                                   class="btn btn-danger"
                                                   name="_eventId_AttributeReleaseRejected"
                                                   value="#springMessageText("idp.attribute-release.reject", "Reject")">
                                            <input type="submit"
                                                   name="_eventId_proceed"
                                                   class="btn btn-success"
                                                   value="#springMessageText("idp.attribute-release.accept", "Accept")">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
        </div>
        <!-- Bootstrap Italia footer -->
        #parse("bi_footer.vm")

        <!-- Bootstrap Italia bottom scripts -->
        #parse("bi_bottom_scripts.vm")
 	</body>
</html>
